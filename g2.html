<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Platformer Runner - Camera Follow</title>
<style>
body { margin:0; overflow:hidden; background:#87CEEB; }
canvas { display:block; background:#87CEEB; }
</style>
</head>
<body>
<canvas id="gameCanvas"></canvas>
<script src="https://cdn.jsdelivr.net/npm/matter-js@0.20.0/build/matter.min.js"></script>
<script>
const { Engine, Render, Runner, Bodies, World, Body, Events, Composite, Query } = Matter;

const canvas=document.getElementById("gameCanvas");
canvas.width=window.innerWidth;
canvas.height=window.innerHeight;

const mapData = {
  "playerStart": { "x": -118, "y": -247 },
  "platforms": [
    { "x": -408,"y": -127,"w": 43.36,"h": 91.23 },
    { "x": 189,"y": 55,"w": 112.01,"h": 335.76 },
    { "x": -416,"y": 76,"w": 103.66,"h": 314.61 },
    { "x": -118,"y": 131,"w": 386.99,"h": 195.99 },
    { "x": 21,"y": 298,"w": 1216.11,"h": 10 },
    { "x": 190,"y": -150,"w": 34.51,"h": 81.99 },
    { "x": -127,"y": -98,"w": 100,"h": 20 },
    { "x": -201,"y": -31,"w": 100,"h": 20 },
    { "x": -41,"y": -31,"w": 100,"h": 20 },
    { "x": -120,"y": -178,"w": 11.65,"h": 68.49 },
    { "x": 292,"y": 68,"w": 100,"h": 20 },
    { "x": 398,"y": 141,"w": 100,"h": 20 },
    { "x": 510,"y": 221,"w": 100,"h": 20 },
    { "x": 504,"y": 66,"w": 100,"h": 20 },
    { "x": 612,"y": -31,"w": 100,"h": 20 },
    { "x": 377,"y": -32,"w": 100,"h": 20 },
    { "x": 498,"y": -130,"w": 100,"h": 20 },
    { "x": 605,"y": -228,"w": 100,"h": 20 },
    { "x": 379,"y": -278,"w": 100,"h": 20 }
  ],
  "movingPlatforms": [

  ]
}

const engine = Engine.create();
engine.world.gravity.y = 1.2;
const world = engine.world;

const render = Render.create({
    canvas,
    engine: engine,
    options: { width:canvas.width, height:canvas.height, wireframes:false, background:'#87CEEB' }
});
Render.run(render);
Runner.run(Runner.create(),engine);

function createStonePattern(){
  const c=document.createElement('canvas'), ctx=c.getContext('2d');
  c.width=c.height=40;
  ctx.fillStyle='#654321'; ctx.fillRect(0,0,40,40);
  ctx.fillStyle='#7B6E59';
  ctx.fillRect(2,2,36,16); ctx.fillRect(2,22,16,16); ctx.fillRect(22,22,16,16);
  ctx.strokeStyle='#382D1B'; ctx.lineWidth=1;
  ctx.strokeRect(2,2,36,16); ctx.strokeRect(2,22,16,16); ctx.strokeRect(22,22,16,16);
  return render.context.createPattern(c,'repeat');
}
const stonePattern=createStonePattern();

mapData.platforms.forEach(p=>{
  const b=Bodies.rectangle(p.x,p.y,p.w,p.h,{isStatic:true,render:{fillStyle:stonePattern}, label: 'static-platform'});
  World.add(world,b);
});

const movingPlatforms = [];
mapData.movingPlatforms.forEach(p=>{
  const platform = Bodies.rectangle(p.x, p.y, p.w, p.h, {
    isStatic: true,
    render: { fillStyle: 'red' },
    label: 'moving-platform'
  });
  platform.originalX = p.x;
  platform.originalY = p.y;
  platform.moveRange = p.moveRange;
  platform.moveAxis = p.moveAxis || 'y';
  platform.lastPosition = { x: p.x, y: p.y };
  movingPlatforms.push(platform);
  World.add(world, platform);
});

const player=Bodies.rectangle(mapData.playerStart.x,mapData.playerStart.y,50,50,{
  restitution:0.05, friction:0.01, frictionAir:0.02,
  render:{sprite:{texture:'https://threejs.org/examples/textures/crate.gif',xScale:0.2,yScale:0.2}},
  label: 'player'
});
World.add(world,player);

const keys={left:false,right:false,up:false,dash:false};
let isDashing=false,dashStartTime=0,lastDashTime=0;
const dashCooldown=2000,dashDuration=100;

document.addEventListener('keydown',e=>{
  if(e.code==='ArrowLeft') keys.left=true;
  if(e.code==='ArrowRight') keys.right=true;
  if(e.code==='ArrowUp') keys.up=true;
  if(e.code==='ShiftLeft'||e.code==='ShiftRight') keys.dash=true;
});
document.addEventListener('keyup',e=>{
  if(e.code==='ArrowLeft') keys.left=false;
  if(e.code==='ArrowRight') keys.right=false;
  if(e.code==='ArrowUp') keys.up=false;
  if(e.code==='ShiftLeft'||e.code==='ShiftRight') keys.dash=false;
});

function isPlayerOnGround(){
  const playerBounds = player.bounds;
  const checkX = player.position.x;
  const checkY = playerBounds.max.y + 5;
  const checkWidth = 10;
  const checkHeight = 10;

  const sensor = Bodies.rectangle(checkX, checkY, checkWidth, checkHeight, { isSensor: true, isStatic: true });
  const collisions = Query.collides(sensor, Composite.allBodies(world));
  
  World.remove(world, sensor);

  return collisions.some(c => {
    let otherBody = (c.bodyA === sensor) ? c.bodyB : c.bodyA;
    return otherBody.label === 'static-platform' || otherBody.label === 'moving-platform';
  });
}

Events.on(engine,'beforeUpdate',()=>{
  const speed=5,dashSpeed=15;
  const canDashNow=Date.now()-lastDashTime>=dashCooldown;
  if(keys.dash&&!isDashing&&canDashNow){
    let dashDir=0; if(keys.left) dashDir=-dashSpeed; if(keys.right) dashDir=dashSpeed;
    if(dashDir!==0){Body.setVelocity(player,{x:dashDir,y:player.velocity.y}); isDashing=true; dashStartTime=Date.now(); lastDashTime=Date.now();}
  }
  if(isDashing && Date.now()-dashStartTime>=dashDuration){isDashing=false; Body.setVelocity(player,{x:0,y:player.velocity.y});}
  if(!isDashing){
    const curr=player.velocity.x;
    const target=(keys.right?speed:0)-(keys.left?speed:0);
    Body.setVelocity(player,{x:curr+(target-curr)*0.2,y:player.velocity.y});
  }
  if(keys.up&&isPlayerOnGround()){Body.setVelocity(player,{x:player.velocity.x,y:-15});}

  const time = engine.timing.timestamp * 0.002;
  movingPlatforms.forEach(platform => {
    let newX = platform.position.x;
    let newY = platform.position.y;

    if(platform.moveAxis === 'y') {
      newY = platform.originalY + Math.sin(time) * platform.moveRange;
      const deltaY = newY - platform.position.y;
      Body.setPosition(platform, { x: platform.position.x, y: newY });
      if(isPlayerOnGround() && deltaY > 0) {
        Body.setPosition(player, { x: player.position.x, y: player.position.y + deltaY });
      }
    } else if(platform.moveAxis === 'x') {
      newX = platform.originalX + Math.sin(time) * platform.moveRange;
      const deltaX = newX - platform.position.x;
      Body.setPosition(platform, { x: newX, y: platform.position.y });
      const playerOnPlatform = Query.collides(player, [platform]).length > 0;
      if(playerOnPlatform) {
        Body.setPosition(player, { x: player.position.x + deltaX, y: player.position.y });
      }
    }
  });

  const followX = player.position.x - canvas.width/2;
  const followY = player.position.y - canvas.height/2;
  const camX = render.bounds.min.x + (followX - render.bounds.min.x) * 0.1;
  const camY = render.bounds.min.y + (followY - render.bounds.min.y) * 0.1;
  Render.lookAt(render,{min:{x:camX,y:camY}, max:{x:camX+canvas.width,y:camY+canvas.height}});
});

window.addEventListener('resize',()=>{
  canvas.width=window.innerWidth;
  canvas.height=window.innerHeight;
  Render.lookAt(render,{min:{x:0,y:0}, max:{x:canvas.width,y:canvas.height}});
});
</script>
</body>
</html>
